(function(g,u){typeof exports=="object"&&typeof module<"u"?module.exports=u():typeof define=="function"&&define.amd?define(u):(g=typeof globalThis<"u"?globalThis:g||self,g.MyBot=u())})(this,function(){"use strict";return{run:async u=>{await WA.onInit(),await WA.players.configureTracking({players:!0});let y,m=!1,b={};async function A(e,o){var p;const n="https://api-production-db6f.up.railway.app/v1/chat-messages",w="Bearer YOUR_API_KEY_HERE",d={inputs:{},query:e,response_mode:"streaming",conversation_id:b[o]||"",user:o,files:[]};try{console.log(`Handling chat message for bot: ${y}, message: ${e}`),WA.chat.startTyping({scope:"bubble"});const a=await fetch(n,{method:"POST",headers:{Authorization:w,"Content-Type":"application/json"},body:JSON.stringify(d)});if(!a.ok)throw new Error(`Failed to handle chat message: ${a.statusText}`);const r=(p=a.body)==null?void 0:p.getReader(),s=new TextDecoder;let i="";for(;;){const{done:c,value:h}=await(r==null?void 0:r.read());if(c)break;const $=s.decode(h,{stream:!0}).split(`
`);for(const f of $)if(f.trim()){const E=f.startsWith("data: ")?f.slice(6):f;try{const l=JSON.parse(E);l.answer&&(i+=l.answer),l.conversation_id&&(b[o]=l.conversation_id)}catch(l){console.error("Error parsing chunk:",l)}}}console.log("Custom AI text response:",i.trim()),WA.chat.sendChatMessage(i.trim(),{scope:"bubble"}),WA.chat.stopTyping({scope:"bubble"}),console.log("Chat message handled successfully.")}catch(a){console.error("Failed to handle chat message:",a)}}async function W(){try{console.log("Initializing bot with metadata:",u),y=WA.room.hashParameters.model||"kos",console.log(y+" is ready!"),console.log("Bot initialized successfully.")}catch(e){console.error("Failed to initialize bot:",e)}}async function U(e){try{console.log(`User ${e.name} with UUID ${e.uuid} joined the proximity meeting.`),console.log("Participant join handled successfully.")}catch(o){console.error("Failed to handle participant join:",o)}}try{await W(),WA.player.proximityMeeting.onJoin().subscribe(async e=>{await U(e)}),m||(WA.chat.onChatMessage(async(e,o)=>{if(!o.author){console.log("Received message with no author, ignoring.");return}console.log(`Received message from ${o.author.name}: ${e}`),await A(e,o.author.uuid)},{scope:"bubble"}),m=!0),console.log("Bot initialized!")}catch(e){console.error("Failed to run bot:",e)}WA.onInit().then(()=>{console.log("Initializing grouping..."),WA.state.onVariableChange("grouping").subscribe(()=>{C()})}).catch(e=>console.error("Error during WA.onInit:",e));async function C(){try{const e=Number(WA.state.grouping);console.log("Current grouping state:",e),await I(e)}catch(e){console.error("Error in updateGrouping:",e)}}async function I(e){e===1?(WA.event.broadcast("ping","start"),await P()):e===0?(WA.event.broadcast("ping","stop"),t=[],console.log("Cleared UUIDs array"),["Purple","Blue","Red","Green","Yellow","Orange"].forEach(n=>{WA.state[n]=[],console.log(`Cleared group ${n}`)})):console.warn("Unknown grouping state:",e)}let t=[];async function P(){t=[];const e=WA.event.on("pong").subscribe(o=>{const n=o.data;t.includes(n)||t.push(n)});try{await new Promise(o=>{setTimeout(()=>{o()},3e3)})}finally{e.unsubscribe(),G()}}async function G(){const e=["Purple","Blue","Red","Green","Yellow","Orange"],o={Purple:[],Blue:[],Red:[],Green:[],Yellow:[],Orange:[]},n=WA.player.uuid;console.log("My UUID:",n),t=t.filter(s=>s!==n),t.sort(()=>Math.random()-.5);const d=Math.min(e.length,Math.floor(t.length/2)),p=Math.floor(t.length/d),a=t.length%d;let r=0;e.slice(0,d).forEach((s,i)=>{const c=i<a?1:0,h=p+c;o[s]=t.slice(r,r+h),r+=h}),console.log("Formed groups:",o),Object.keys(o).forEach(s=>{o[s].forEach(c=>{console.log(`UUID ${c} is in group ${s}`),WA.event.broadcast(c,s)})}),M()}function M(){["Blue","Green","Orange","Red","Yellow","Purple"].forEach(o=>{const n=Math.floor(1e3+Math.random()*9e3).toString();WA.state[`code${o}`]=n,console.log(`Generated code for ${o}: ${n}`)})}}}});
